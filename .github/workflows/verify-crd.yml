name: Verify CRD & Deepcopy up-to-date

on:
  push:
    branches: [ "**" ]
    paths:
      - 'HadesScheduler/HadesOperator/api/v1/buildjob_types.go'
      - 'HadesScheduler/HadesOperator/api/v1/zz_generated.deepcopy.go'
      - 'helm/hades/crds/build.hades.tum.de_buildjobs.yaml'
  pull_request:
    branches: [ "**" ]
    paths:
      - 'HadesScheduler/HadesOperator/api/v1/buildjob_types.go'
      - 'HadesScheduler/HadesOperator/api/v1/zz_generated.deepcopy.go'
      - 'helm/hades/crds/build.hades.tum.de_buildjobs.yaml'

jobs:
  verify:
    name: Verify generated files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
          cache: true

      - name: Hash BEFORE
        id: prehash
        shell: bash
        run: |
          set -euo pipefail
          CRD='helm/hades/crds/build.hades.tum.de_buildjobs.yaml'
          DEEP='HadesScheduler/HadesOperator/api/v1/zz_generated.deepcopy.go'

          if [ -f "$CRD" ]; then
            CRD_HASH_BEFORE=$(sha256sum "$CRD" | cut -d' ' -f1)
          else
            CRD_HASH_BEFORE="MISSING"
          fi

          if [ -f "$DEEP" ]; then
            DEEP_HASH_BEFORE=$(sha256sum "$DEEP" | cut -d' ' -f1)
          else
            DEEP_HASH_BEFORE="MISSING"
          fi

          echo "crd=$CRD" >> "$GITHUB_OUTPUT"
          echo "deep=$DEEP" >> "$GITHUB_OUTPUT"
          echo "crd_before=$CRD_HASH_BEFORE" >> "$GITHUB_OUTPUT"
          echo "deep_before=$DEEP_HASH_BEFORE" >> "$GITHUB_OUTPUT"

          echo "CRD(before):  $CRD_HASH_BEFORE"
          echo "DEEP(before): $DEEP_HASH_BEFORE"

      - name: Regenerate CRD & deepcopy
        run: |
          set -e
          make -C HadesScheduler/HadesOperator manifests generate

      - name: Hash AFTER & Compare
        shell: bash
        run: |
          set -euo pipefail
          CRD='${{ steps.prehash.outputs.crd }}'
          DEEP='${{ steps.prehash.outputs.deep }}'

          if [ ! -f "$CRD" ]; then
            echo "::error title=CRD not generated::Expected $CRD after generation"
            exit 1
          fi
          if [ ! -f "$DEEP" ]; then
            echo "::error title=Deepcopy not generated::Expected $DEEP after generation"
            exit 1
          fi

          CRD_HASH_AFTER=$(sha256sum "$CRD" | cut -d' ' -f1)
          DEEP_HASH_AFTER=$(sha256sum "$DEEP" | cut -d' ' -f1)

          echo "CRD(after):   $CRD_HASH_AFTER"
          echo "DEEP(after):  $DEEP_HASH_AFTER"

          if [ "${{ steps.prehash.outputs.crd_before }}" != "$CRD_HASH_AFTER" ] || \
             [ "${{ steps.prehash.outputs.deep_before }}" != "$DEEP_HASH_AFTER" ]; then
            echo "::error title=Generated files out of date::Run 'make -C HadesScheduler/HadesOperator manifests generate' locally and commit the updated files:"
            echo " - $CRD"
            echo " - $DEEP"
            exit 1
          fi

          echo "Generated files are up-to-date âœ…"
