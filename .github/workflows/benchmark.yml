name: Benchmark Hades

on:
  workflow_dispatch:
    inputs:
      count:
        description: "How many benchmark jobs to trigger"
        required: false
        default: "1000"

jobs:
  benchmark:
    name: Trigger Benchmark
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      BENCHMARK_URL: "https://ma-yu.aet.cit.tum.de/v1/benchmark/hades"
      COUNT: ${{ inputs.count || '1000' }}
      COMMIT_HASH: ${{ github.sha }}
      GH_USER: ${{ secrets.GH_USER }}
      GH_PASSWORD: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Ensure jq is available (usually preinstalled)
        run: |
          set -e
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Trigger Benchmark for commit
        run: |
          set -euo pipefail
          echo "Triggering benchmark for commit $COMMIT_HASH (count=$COUNT)"

          payload="$(
            jq -n \
              --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --arg gh_user "$GH_USER" \
              --arg gh_password "$GH_PASSWORD" \
              '{
                name: "Benchmark Hades Job",
                metadata: { GLOBAL: "triggered-via-github-actions" },
                timestamp: $timestamp,
                priority: 3,
                steps: [
                  {
                    id: 1,
                    name: "Report Starting Time",
                    image: "ghcr.io/ls1intum/hades-reporter/hades-reporter:latest",
                    metadata: {
                      ENDPOINT: "https://hades-benchmarker.wei-tech.site/v1/start_time"
                    }
                  },
                  {
                    id: 2,
                    name: "Clone",
                    image: "ghcr.io/ls1intum/hades/hades-clone-container:latest",
                    metadata: {
                      REPOSITORY_DIR: "/shared",
                      HADES_TEST_USERNAME: $gh_user,
                      HADES_TEST_PASSWORD: $gh_password,
                      HADES_TEST_URL: "https://github.com/Mtze/Artemis-Java-Test.git",
                      HADES_TEST_PATH: "./example",
                      HADES_TEST_ORDER: "1",
                      HADES_ASSIGNMENT_USERNAME: $gh_user,
                      HADES_ASSIGNMENT_PASSWORD: $gh_password,
                      HADES_ASSIGNMENT_URL: "https://github.com/Mtze/Artemis-Java-Solution.git",
                      HADES_ASSIGNMENT_PATH: "./example/assignment",
                      HADES_ASSIGNMENT_ORDER: "2"
                    }
                  },
                  {
                    id: 3,
                    name: "Execute",
                    image: "ls1tum/artemis-maven-template:java17-18",
                    script: "set -e && cd /shared/example && ./gradlew --status && ./gradlew clean test"
                  },
                  {
                    id: 4,
                    name: "Result",
                    image: "ghcr.io/ls1intum/hades/junit-result-parser:latest",
                    metadata: {
                      API_ENDPOINT: "https://hades-benchmarker.wei-tech.site/v1/result",
                      INGEST_DIR: "./shared/example",
                      HADES_TEST_PATH: "./example",
                      HADES_ASSIGNMENT_PATH: "./example/assignment"
                    }
                  }
                ]
              }'
          )"

          # send the payload to the benchmark server with retry
          echo "$payload" | curl -fsS --retry 3 --retry-delay 2 --max-time 120 \
            -X POST "${BENCHMARK_URL}?count=${COUNT}&commit_hash=${COMMIT_HASH}" \
            -H "Content-Type: application/json" \
            --data-binary @-

          echo "Benchmark trigger accepted."
